---
name: Security scan for IaC with Checkov
on:
  workflow_call:
    inputs:
      scan-directory:
        required: false
        type: string
        description: Directory to scan (ignored if scan-file is set)
        default: .
      scan-file:
        required: false
        type: string
        description: File to scan (overrides scan-directory)
        default: null
      framework:
        required: false
        type: string
        description: Frameworks to scan (comma-separated)
        default: all
      skip-framework:
        required: false
        type: string
        description: Frameworks to skip (comma-separated)
        default: null
      check:
        required: false
        type: string
        description: Checks to include (comma-separated IDs or severities)
        default: null
      skip-check:
        required: false
        type: string
        description: Checks to skip (comma-separated IDs or severities)
        default: null
      skip-cve-package:
        required: false
        type: string
        description: CVE packages to skip in SCA scans (comma-separated)
        default: null
      output:
        required: false
        type: string
        description: Output formats (comma-separated)
        default: cli
      output-file-path:
        required: false
        type: string
        description: Output file path(s) for selected formats
        default: null
      output-bc-ids:
        required: false
        type: boolean
        description: Output Bridgecrew IDs instead of Checkov IDs
        default: false
      quiet:
        required: false
        type: boolean
        description: Display only failed checks in CLI output
        default: false
      soft-fail:
        required: false
        type: boolean
        description: Always return exit code 0
        default: false
      download-external-modules:
        required: false
        type: boolean
        description: Download external Terraform modules
        default: false
      repo-root-for-plan-enrichment:
        required: false
        type: string
        description: Directory containing HCL code for plan enrichment
        default: null
      var-file:
        required: false
        type: string
        description: Variable files to load
        default: null
      log-level:
        required: false
        type: string
        description: Log level for Checkov
        default: null
      config-file:
        required: false
        type: string
        description: Checkov config file path
        default: null
      baseline:
        required: false
        type: string
        description: Baseline file path
        default: null
      container-user:
        required: false
        type: string
        description: Container user ID or UID:GID
        default: null
      use-enforcement-rules:
        required: false
        type: boolean
        description: Use enforcement rules from the platform
        default: false
      docker-image:
        required: false
        type: string
        description: Docker image name or ID to scan
        default: null
      dockerfile-path:
        required: false
        type: string
        description: Path to Dockerfile for image scanning
        default: null
      runs-on:
        required: false
        type: string
        description: GitHub Actions runner to use
        default: ubuntu-latest
    secrets:
      BC_API_KEY:
        required: false
        description: Bridgecrew or Prisma Cloud API key
      GH_PAT:
        required: false
        description: GitHub PAT for private module downloads
permissions:
  contents: read
jobs:
  checkov-scan:
    runs-on: ${{ inputs.runs-on }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Run Checkov
        uses: bridgecrewio/checkov-action@8f61ce5b8a3afb4ca94d236b75201878ded6d2cd  # v12
        with:
          directory: ${{ inputs.scan-directory }}
          file: ${{ inputs.scan-file }}
          framework: ${{ inputs.framework }}
          skip_framework: ${{ inputs.skip-framework }}
          check: ${{ inputs.check }}
          skip_check: ${{ inputs.skip-check }}
          skip_cve_package: ${{ inputs.skip-cve-package }}
          output_format: ${{ inputs.output }}
          output_file_path: ${{ inputs.output-file-path }}
          output_bc_ids: ${{ inputs.output-bc-ids }}
          quiet: ${{ inputs.quiet }}
          soft_fail: ${{ inputs.soft-fail }}
          download_external_modules: ${{ inputs.download-external-modules }}
          repo_root_for_plan_enrichment: ${{ inputs.repo-root-for-plan-enrichment }}
          var_file: ${{ inputs.var-file }}
          log_level: ${{ inputs.log-level }}
          config_file: ${{ inputs.config-file }}
          baseline: ${{ inputs.baseline }}
          container_user: ${{ inputs.container-user }}
          use_enforcement_rules: ${{ inputs.use-enforcement-rules }}
          docker_image: ${{ inputs.docker-image }}
          dockerfile_path: ${{ inputs.dockerfile-path }}
          api-key: ${{ secrets.BC_API_KEY }}
          github_pat: ${{ secrets.GH_PAT }}

---
name: Amp Code
on:
  workflow_dispatch:  # checkov:skip=CKV_GHA_7:workflow_dispatch inputs are required for manual runs
    inputs:
      prompt:
        required: true
        type: string
        description: Prompt string passed to Amp Code's `-x` argument for execution mode
      amp-log-level:
        required: false
        type: string
        description: Amp log level (error, warn, info, debug)
        default: info
      amp-settings-json:
        required: false
        type: string
        description: JSON string for Amp settings (written to settings.json)
        default: null
      amp-dangerously-allow-all:
        required: false
        type: boolean
        description: Toggle Amp CLI --dangerously-allow-all
        default: true
      mcp-config:
        required: false
        type: string
        description: MCP server configuration JSON string
        default: null
      runs-on:
        required: false
        type: string
        description: GitHub Actions runner to use
        default: ubuntu-slim
  workflow_call:
    inputs:
      prompt:
        required: true
        type: string
        description: Prompt string passed to Amp Code's `-x` argument for execution mode
      amp-log-level:
        required: false
        type: string
        description: Amp log level (error, warn, info, debug)
        default: info
      amp-settings-json:
        required: false
        type: string
        description: JSON string for Amp settings (written to settings.json)
        default: null
      amp-dangerously-allow-all:
        required: false
        type: boolean
        description: Toggle Amp CLI --dangerously-allow-all
        default: true
      mcp-config:
        required: false
        type: string
        description: MCP server configuration JSON string
        default: null
      runs-on:
        required: false
        type: string
        description: GitHub Actions runner to use
        default: ubuntu-slim
    outputs:
      summary:
        description: Summary of Amp Code execution
        value: ${{ jobs.amp-code.outputs.summary }}
    secrets:
      AMP_API_KEY:
        required: true
        description: Amp API key from ampcode.com/settings
      GH_TOKEN:
        required: false
        description: GitHub token for repository operations
permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write
  actions: read
defaults:
  run:
    shell: bash -euo pipefail {0}
    working-directory: .
jobs:
  amp-code:
    runs-on: ${{ inputs.runs-on }}
    outputs:
      summary: ${{ steps.run-amp.outputs.summary }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          persist-credentials: false
      - name: Install Amp CLI
        run: >
          curl -fsSL https://ampcode.com/install.sh | bash
      - name: Verify Amp installation
        run: >
          ~/.local/bin/amp --version
          echo "PATH=${PATH}:${HOME}/.local/bin" | tee -a "${GITHUB_ENV}"
      - name: Configure Amp settings
        if: inputs.amp-settings-json != null
        env:
          AMP_SETTINGS_JSON: ${{ inputs.amp-settings-json }}
          AMP_SETTINGS_FILE: ${{ env.HOME }}/.config/amp/settings.json
        run: |
          mkdir -p "$(dirname "${AMP_SETTINGS_FILE}")"
          jq . <<< "${AMP_SETTINGS_JSON}" | tee "${AMP_SETTINGS_FILE}"
          echo "AMP_SETTINGS_FILE=${AMP_SETTINGS_FILE}" | tee -a "${GITHUB_ENV}"
      - name: Run Amp Code
        id: run-amp
        env:
          AMP_API_KEY: ${{ secrets.AMP_API_KEY }}
          AMP_URL: https://ampcode.com/
          AMP_LOG_LEVEL: ${{ inputs.amp-log-level }}
          AMP_DANGEROUSLY_ALLOW_ALL: ${{ inputs.amp-dangerously-allow-all }}
          MCP_CONFIG: ${{ inputs.mcp-config }}
          PROMPT: ${{ inputs.prompt }}
        run: |
          amp_args=(
            ${MCP_CONFIG:+--mcp-config="${MCP_CONFIG}"}
            ${AMP_DANGEROUSLY_ALLOW_ALL:+--dangerously-allow-all}
          )
          output_file=$(mktemp)
          amp "${amp_args[@]}" -x "${PROMPT}" 2>&1 | tee "${output_file}"
          exit_code=${PIPESTATUS[0]}
          summary=$(head -c 1000 "${output_file}" | tr '\n' ' ' | sed 's/  */ /g')
          {
            echo "summary<<EOF"
            echo "${summary}"
            echo "EOF"
          } >> "${GITHUB_OUTPUT}"
          rm -f "${output_file}"
          exit "${exit_code}"

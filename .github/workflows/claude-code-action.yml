---
name: Claude Code Action
on:
  workflow_call:
    inputs:
      prompt:
        required: false
        type: string
        description: Instructions for Claude. Can be a direct prompt or custom template.
        default: ''
      claude-args:
        required: false
        type: string
        description: Additional arguments to pass directly to Claude CLI
        default: ''
      track-progress:
        required: false
        type: boolean
        description: Force tag mode with tracking comments for supported PR/issue events
        default: false
      trigger-phrase:
        required: false
        type: string
        description: The trigger phrase to look for in comments or issue body
        default: '@claude'
      assignee-trigger:
        required: false
        type: string
        description: The assignee username that triggers the action
        default: null
      label-trigger:
        required: false
        type: string
        description: The label that triggers the action
        default: 'claude'
      base-branch:
        required: false
        type: string
        description: The branch to use as the base/source when creating new branches (defaults to repository default branch)
        default: null
      branch-prefix:
        required: false
        type: string
        description: The prefix to use for Claude branches (defaults to 'claude/', use 'claude-' for dash format)
        default: 'claude/'
      settings:
        required: false
        type: string
        description: Claude Code settings as JSON string or path to settings JSON file
        default: ''
      additional-permissions:
        required: false
        type: string
        description: "Additional permissions to enable (e.g., 'actions: read')"
        default: ''
      use-sticky-comment:
        required: false
        type: boolean
        description: Use just one comment to deliver issue/PR comments
        default: false
      use-commit-signing:
        required: false
        type: boolean
        description: Enable commit signing using GitHub's commit signature verification
        default: false
      bot-id:
        required: false
        type: string
        description: GitHub user ID to use for git operations (defaults to Claude's bot ID)
        default: '41898282'
      bot-name:
        required: false
        type: string
        description: GitHub username to use for git operations (defaults to Claude's bot name)
        default: 'claude[bot]'
      allowed-bots:
        required: false
        type: string
        description: Comma-separated list of allowed bot usernames, or '*' to allow all bots
        default: ''
      allowed-non-write-users:
        required: false
        type: string
        description: Comma-separated list of usernames to allow without write permissions; only works with github_token
        default: ''
      path-to-claude-code-executable:
        required: false
        type: string
        description: Optional path to a custom Claude Code executable
        default: ''
      path-to-bun-executable:
        required: false
        type: string
        description: Optional path to a custom Bun executable
        default: ''
      show-full-output:
        required: false
        type: boolean
        description: 'Show full JSON output from Claude Code (WARNING: may expose sensitive data)'
        default: false
      plugin-marketplaces:
        required: false
        type: string
        description: Newline-separated list of Claude Code plugin marketplace Git URLs
        default: ''
      plugins:
        required: false
        type: string
        description: Newline-separated list of Claude Code plugin names to install
        default: ''
      aws-iam-role-to-assume:
        required: false
        type: string
        description: AWS IAM role ARN to assume
        default: null
      aws-region:
        required: false
        type: string
        description: AWS region to use
        default: us-east-1
      google-workload-identity-provider:
        required: false
        type: string
        description: Google Workload Identity Provider to use for authentication
        default: null
      google-service-account:
        required: false
        type: string
        description: Google Service Account to use for authentication
        default: null
      use-foundry:
        required: false
        type: boolean
        description: Use Microsoft Foundry with OIDC authentication instead of direct Anthropic API
        default: false
      runs-on:
        required: false
        type: string
        description: Runner to use
        default: ubuntu-slim
      timeout-minutes:
        required: false
        type: number
        description: Timeout in minutes for execution
        default: 30
    outputs:
      execution-file:
        description: Path to the Claude Code execution output file
        value: ${{ jobs.claude-code-action.outputs.execution-file }}
      branch-name:
        description: The branch created by Claude Code for this execution
        value: ${{ jobs.claude-code-action.outputs.branch-name }}
      structured-output:
        description: JSON string containing all structured output fields when --json-schema is provided in claude-args
        value: ${{ jobs.claude-code-action.outputs.structured-output }}
      session-id:
        description: The Claude Code session ID that can be used with --resume
        value: ${{ jobs.claude-code-action.outputs.session-id }}
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: false
        description: OAuth token for Claude Code (if applicable)
      ANTHROPIC_API_KEY:
        required: false
        description: Anthropic API key for Claude
      OPENROUTER_API_KEY:
        required: false
        description: OpenRouter API key for Claude via OpenRouter
      GH_TOKEN:
        required: false
        description: GitHub token for creating comments/issues
permissions:
  contents: read
  pull-requests: write
  issues: write
  id-token: write
  actions: read
jobs:
  claude-code-action:
    runs-on: ${{ inputs.runs-on }}
    timeout-minutes: ${{ inputs.timeout-minutes || 30 }}
    outputs:
      execution-file: ${{ steps.claude-code-action.outputs.execution_file }}
      branch-name: ${{ steps.claude-code-action.outputs.branch_name }}
      structured-output: ${{ steps.claude-code-action.outputs.structured_output }}
      session-id: ${{ steps.claude-code-action.outputs.session_id }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          persist-credentials: false
      - name: Configure AWS credentials
        if: inputs.aws-iam-role-to-assume != null
        uses: aws-actions/configure-aws-credentials@8df5847569e6427dd6c4fb1cf565c83acfa8afa7  # v6.0.0
        with:
          role-to-assume: ${{ inputs.aws-iam-role-to-assume }}
          aws-region: ${{ inputs.aws-region || 'us-east-1' }}
          role-session-name: github-actions-${{ github.run_id }}
      - name: Authenticate to Google Cloud
        if: inputs.google-workload-identity-provider != null && inputs.google-service-account != null
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093  # v3.0.0
        with:
          workload_identity_provider: ${{ inputs.google-workload-identity-provider }}
          service_account: ${{ inputs.google-service-account }}
      - name: Run Claude Code Action
        id: claude-code-action
        uses: anthropics/claude-code-action@1b8ee3b94104046d71fde52ec3557651ad8c0d71  # v1.0.29
        env:
          ANTHROPIC_BASE_URL: ${{ secrets.OPENROUTER_API_KEY != null && 'https://openrouter.ai/api/v1' || '' }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY || secrets.OPENROUTER_API_KEY }}
          prompt: ${{ inputs.prompt }}
          claude_args: ${{ inputs.claude-args }}
          track_progress: ${{ inputs.track-progress }}
          trigger_phrase: ${{ inputs.trigger-phrase || '@claude' }}
          assignee_trigger: ${{ inputs.assignee-trigger }}
          label_trigger: ${{ inputs.label-trigger }}
          base_branch: ${{ inputs.base-branch }}
          branch_prefix: ${{ inputs.branch-prefix }}
          settings: ${{ inputs.settings }}
          additional_permissions: ${{ inputs.additional-permissions }}
          use_sticky_comment: ${{ inputs.use-sticky-comment }}
          use_commit_signing: ${{ inputs.use-commit-signing }}
          bot_id: ${{ inputs.bot-id }}
          bot_name: ${{ inputs.bot-name }}
          allowed_bots: ${{ inputs.allowed-bots }}
          allowed_non_write_users: ${{ inputs.allowed-non-write-users }}
          path_to_claude_code_executable: ${{ inputs.path-to-claude-code-executable }}
          path_to_bun_executable: ${{ inputs.path-to-bun-executable }}
          show_full_output: ${{ inputs.show-full-output }}
          plugin_marketplaces: ${{ inputs.plugin-marketplaces }}
          plugins: ${{ inputs.plugins }}
          use_bedrock: ${{ inputs.aws-iam-role-to-assume != null }}
          use_vertex: ${{ inputs.google-workload-identity-provider != null && inputs.google-service-account != null }}
          use_foundry: ${{ inputs.use-foundry }}

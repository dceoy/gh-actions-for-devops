---
name: Deployment of Google Cloud resources using Infrastructure Manager
on:
  workflow_call:
    inputs:
      project-id:
        required: true
        type: string
        description: Google Cloud project ID to use
      infra-manager-deployment-name:
        required: true
        type: string
        description: Infrastructure Manager deployment ID
      workload-identity-provider:
        required: true
        type: string
        description: Workload Identity Provider to use for authentication
      workload-identity-service-account-name:
        required: false
        type: string
        description: Service Account name to use for Workload Identity Federation
        default: null
      location:
        required: false
        type: string
        description: Google Cloud location
        default: us-central1
      gcloud-version:
        required: false
        type: string
        description: gcloud CLI version to use
        default: latest
      gcloud-components:
        required: false
        type: string
        description: gcloud components to install (comma-separated)
        default: null
      infra-manager-source-directory:
        required: false
        type: string
        description: Local directory containing Terraform configuration for Infrastructure Manager
        default: .
      infra-manager-input-values:
        required: false
        type: string
        description: Comma-separated input values (e.g., "region=us-central1,env=prod")
        default: null
      infra-manager-inputs-file:
        required: false
        type: string
        description: Path to inputs file for Infrastructure Manager
        default: null
      infra-manager-service-account-name:
        required: false
        type: string
        description: Service account name for Infrastructure Manager deployment execution
        default: null
      infra-manager-artifacts-gcs-bucket:
        required: false
        type: string
        description: GCS bucket to store Infrastructure Manager artifacts
        default: null
      infra-manager-labels:
        required: false
        type: string
        description: Labels to set on the deployment (comma-separated key=value pairs)
        default: null
      infra-manager-annotations:
        required: false
        type: string
        description: Annotations to set on the deployment (comma-separated key=value pairs)
        default: null
      infra-manager-import-existing-resources:
        required: false
        type: boolean
        description: Import existing resources into Infrastructure Manager deployment
        default: true
      infra-manager-delete-policy:
        required: false
        type: string
        description: Delete policy for Infrastructure Manager (abandon, delete, or delete-policy-unspecified)
        default: null
      infra-manager-async:
        required: false
        type: boolean
        description: Run Infrastructure Manager operations asynchronously
        default: false
      apply:
        required: false
        type: boolean
        description: Create or update infrastructure
        default: false
      destroy:
        required: false
        type: boolean
        description: Destroy infrastructure
        default: false
      environment-variables:
        required: false
        type: string
        description: Environment variables to set (e.g., "FOO=bar")
        default: null
      environment-file:
        required: false
        type: string
        description: Environment file to set environment variables
        default: null
      runs-on:
        required: false
        type: string
        description: GitHub Actions runner to use
        default: ubuntu-slim
      timeout-minutes:
        required: false
        type: number
        description: Timeout in minutes for the job
        default: 360
  workflow_dispatch:
    inputs:
      project-id:
        required: true
        type: string
        description: Google Cloud project ID to use
      infra-manager-deployment-name:
        required: true
        type: string
        description: Infrastructure Manager deployment ID
      workload-identity-provider:
        required: true
        type: string
        description: Workload Identity Provider to use for authentication
      workload-identity-service-account-name:
        required: false
        type: string
        description: Service Account name to use for Workload Identity Federation
        default: null
      location:
        required: false
        type: string
        description: Google Cloud location
        default: us-central1
      gcloud-version:
        required: false
        type: string
        description: gcloud CLI version to use
        default: latest
      gcloud-components:
        required: false
        type: string
        description: gcloud components to install (comma-separated)
        default: null
      infra-manager-source-directory:
        required: false
        type: string
        description: Local directory containing Terraform configuration for Infrastructure Manager
        default: .
      infra-manager-input-values:
        required: false
        type: string
        description: Comma-separated input values (e.g., "region=us-central1,env=prod")
        default: null
      infra-manager-inputs-file:
        required: false
        type: string
        description: Path to inputs file for Infrastructure Manager
        default: null
      infra-manager-service-account-name:
        required: false
        type: string
        description: Service account name for Infrastructure Manager deployment execution
        default: null
      infra-manager-artifacts-gcs-bucket:
        required: false
        type: string
        description: GCS bucket to store Infrastructure Manager artifacts
        default: null
      infra-manager-labels:
        required: false
        type: string
        description: Labels to set on the deployment (comma-separated key=value pairs)
        default: null
      infra-manager-annotations:
        required: false
        type: string
        description: Annotations to set on the deployment (comma-separated key=value pairs)
        default: null
      infra-manager-import-existing-resources:
        required: false
        type: boolean
        description: Import existing resources into Infrastructure Manager deployment
        default: true
      infra-manager-delete-policy:
        required: false
        type: string
        description: Delete policy for Infrastructure Manager (abandon, delete, or delete-policy-unspecified)
        default: null
      infra-manager-async:
        required: false
        type: boolean
        description: Run Infrastructure Manager operations asynchronously
        default: false
      apply:
        required: false
        type: boolean
        description: Create or update infrastructure
        default: false
      destroy:
        required: false
        type: boolean
        description: Destroy infrastructure
        default: false
      environment-variables:
        required: false
        type: string
        description: Environment variables to set (e.g., "FOO=bar")
        default: null
      environment-file:
        required: false
        type: string
        description: Environment file to set environment variables
        default: null
      runs-on:
        required: false
        type: string
        description: GitHub Actions runner to use
        default: ubuntu-slim
      timeout-minutes:
        required: false
        type: number
        description: Timeout in minutes for the job
        default: 360
permissions:
  contents: read
  id-token: write
defaults:
  run:
    shell: bash -euo pipefail {0}
    working-directory: .
jobs:
  deploy:
    runs-on: ${{ inputs.runs-on }}
    timeout-minutes: ${{ inputs.timeout-minutes }}
    env:
      WI_SERVICE_ACCOUNT: ${{ inputs.workload-identity-service-account-name && format('projects/{0}/serviceAccounts/{1}@{0}.iam.gserviceaccount.com', inputs.project-id, inputs.workload-identity-service-account-name) || null }}
      IM_SERVICE_ACCOUNT: ${{ inputs.infra-manager-service-account-name && format('projects/{0}/serviceAccounts/{1}@{0}.iam.gserviceaccount.com', inputs.project-id, inputs.infra-manager-service-account-name) || null }}
      IM_PREVIEW: projects/${{ inputs.project-id }}/locations/${{ inputs.location }}/previews/${{ inputs.infra-manager-deployment-name }}-preview
      IM_DEPLOYMENT: projects/${{ inputs.project-id }}/locations/${{ inputs.location }}/deployments/${{ inputs.infra-manager-deployment-name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          fetch-depth: 1
          persist-credentials: false
      - name: Set environment variables from key-value pairs
        if: inputs.environment-variables != null
        env:
          ENVIRONMENT_VARIABLES: ${{ inputs.environment-variables }}
        run: |
          echo "${ENVIRONMENT_VARIABLES}" >> "${GITHUB_ENV}"
      - name: Set environment variables from file
        if: inputs.environment-file != null
        env:
          ENVIRONMENT_FILE: ${{ inputs.environment-file }}
        run: |
          cat "${ENVIRONMENT_FILE}" >> "${GITHUB_ENV}"
      - name: Authenticate to Google Cloud using Workload Identity Federation
        uses: google-github-actions/auth@7c6bc770dae815cd3e89ee6cdf493a5fab2cc093  # v3.0.0
        with:
          project_id: ${{ inputs.project-id }}
          workload_identity_provider: ${{ inputs.workload-identity-provider }}
          service_account: ${{ inputs.workload-identity-service-account-name && env.WI_SERVICE_ACCOUNT || null }}
      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@aa5489c8933f4cc7a4f7d45035b3b1440c9c10db  # v3.0.1
        with:
          version: ${{ inputs.gcloud-version }}
          project_id: ${{ inputs.project-id }}
          install_components: ${{ inputs.gcloud-components }}
      - name: Preview infrastructure using Infrastructure Manager
        if: (! inputs.apply) && (! inputs.destroy)
        env:
          SOURCE_DIR: ${{ inputs.infra-manager-source-directory }}
          INPUT_VALUES: ${{ inputs.infra-manager-input-values }}
          INPUTS_FILE: ${{ inputs.infra-manager-inputs-file }}
          ARTIFACTS_GCS_BUCKET: ${{ inputs.infra-manager-artifacts-gcs-bucket }}
          LABELS: ${{ inputs.infra-manager-labels }}
          ANNOTATIONS: ${{ inputs.infra-manager-annotations }}
          ASYNC: ${{ inputs.infra-manager-async && 'true' || '' }}
        run: |
          create_options=(
            --local-source="${SOURCE_DIR}"
            ${IM_SERVICE_ACCOUNT:+--service-account="${IM_SERVICE_ACCOUNT}"}
            ${INPUT_VALUES:+--input-values="${INPUT_VALUES}"}
            ${INPUTS_FILE:+--inputs-file="${INPUTS_FILE}"}
            ${ARTIFACTS_GCS_BUCKET:+--artifacts-gcs-bucket="${ARTIFACTS_GCS_BUCKET}"}
            ${LABELS:+--labels="${LABELS}"}
            ${ANNOTATIONS:+--annotations="${ANNOTATIONS}"}
            ${ASYNC:+--async}
          )
          gcloud infra-manager previews create "${IM_PREVIEW}" "${create_options[@]}"
      - name: Preview destroy using Infrastructure Manager
        if: (! inputs.apply) && inputs.destroy
        run: |
          create_options=(
            --preview-mode=DELETE
            --deployment="${IM_DEPLOYMENT}"
            ${IM_SERVICE_ACCOUNT:+--service-account="${IM_SERVICE_ACCOUNT}"}
          )
          gcloud infra-manager previews create "${IM_PREVIEW}" "${create_options[@]}"
      - name: Describe Infrastructure Manager preview
        if: (! inputs.apply) && (! inputs.infra-manager-async)
        run: |
          gcloud infra-manager previews describe "${IM_PREVIEW}"
      - name: Create or update infrastructure using Infrastructure Manager
        if: inputs.apply && (! inputs.destroy)
        env:
          SOURCE_DIR: ${{ inputs.infra-manager-source-directory }}
          INPUT_VALUES: ${{ inputs.infra-manager-input-values }}
          INPUTS_FILE: ${{ inputs.infra-manager-inputs-file }}
          ARTIFACTS_GCS_BUCKET: ${{ inputs.infra-manager-artifacts-gcs-bucket }}
          LABELS: ${{ inputs.infra-manager-labels }}
          ANNOTATIONS: ${{ inputs.infra-manager-annotations }}
          IMPORT_EXISTING_RESOURCES: ${{ inputs.infra-manager-import-existing-resources && 'true' || '' }}
          ASYNC: ${{ inputs.infra-manager-async && 'true' || '' }}
        run: |
          apply_options=(
            --local-source="${SOURCE_DIR}"
            ${IM_SERVICE_ACCOUNT:+--service-account="${IM_SERVICE_ACCOUNT}"}
            ${INPUT_VALUES:+--input-values="${INPUT_VALUES}"}
            ${INPUTS_FILE:+--inputs-file="${INPUTS_FILE}"}
            ${ARTIFACTS_GCS_BUCKET:+--artifacts-gcs-bucket="${ARTIFACTS_GCS_BUCKET}"}
            ${LABELS:+--labels="${LABELS}"}
            ${ANNOTATIONS:+--annotations="${ANNOTATIONS}"}
            ${IMPORT_EXISTING_RESOURCES:+--import-existing-resources}
            ${ASYNC:+--async}
          )
          gcloud infra-manager deployments apply "${IM_DEPLOYMENT}" "${apply_options[@]}"
      - name: Describe Infrastructure Manager deployment
        if: inputs.apply && (! inputs.destroy) && (! inputs.infra-manager-async)
        run: |
          gcloud infra-manager deployments describe "${IM_DEPLOYMENT}"
      - name: Destroy infrastructure using Infrastructure Manager
        if: inputs.apply && inputs.destroy
        env:
          DELETE_POLICY: ${{ inputs.infra-manager-delete-policy }}
          ASYNC: ${{ inputs.infra-manager-async && 'true' || '' }}
        run: |
          delete_options=(
            ${DELETE_POLICY:+--delete-policy="${DELETE_POLICY}"}
            ${ASYNC:+--async}
          )
          gcloud infra-manager deployments delete "${IM_DEPLOYMENT}" "${delete_options[@]}"

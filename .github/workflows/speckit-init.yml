---
name: Spec Kit initialization
on:
  workflow_call:
    inputs:
      ai-assistants:
        required: false
        type: string
        description: AI assistants to use (comma-separated)
        default: claude,codex,gemini,copilot
      script-type:
        required: false
        type: string
        description: Script type to use
        default: sh
      prettify-md-and-json:
        required: false
        type: boolean
        description: Whether to prettify Markdown and JSON files after initialization
        default: true
      disable-shellcheck:
        required: false
        type: boolean
        description: Whether to disable shellcheck in Spec Kit shell scripts
        default: true
      git-add-args:
        required: false
        type: string
        description: Arguments for the git add command
        default: .
      version-md-file-to-write:
        required: false
        type: string
        description: Path to a Markdown file to write the `specify version` output to
        default: null
    secrets:
      GH_TOKEN:
        required: false
        description: GitHub token
permissions:
  contents: write
  pull-requests: write
defaults:
  run:
    shell: bash -euo pipefail {0}
    working-directory: .
jobs:
  speckit-init:
    runs-on: ubuntu-slim
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          ref: ${{ github.head_ref || github.ref_name }}
          fetch-depth: 1
          persist-credentials: true
      - name: Set up uv
        uses: astral-sh/setup-uv@803947b9bd8e9f986429fa0c5a41c367cd732b41  # v7.2.1
        with:
          version: latest
      - name: Install Specify CLI
        run: >
          uv tool install specify-cli --from git+https://github.com/github/spec-kit.git
      - name: Setup Node.js
        uses: actions/setup-node@6044e13b5dc448c55e2357c09f80417699197238  # v6.2.0
        with:
          node-version: latest
      - name: Display Specify CLI version
        if: inputs.version-md-file-to-write == null
        run: >
          specify version
      - name: Save Specify CLI version to a Markdown file
        if: inputs.version-md-file-to-write != null
        env:
          VERSION_MD_FILE: ${{ inputs.version-md-file-to-write }}
        run: |
          {
            echo '# Spec Kit Version';
            echo '```';
            specify version;
            echo '```';
          } | tee "${VERSION_MD_FILE}"
      - name: Initialize Spec Kit
        env:
          AI_ASSISTANTS: ${{ inputs.ai-assistants }}
          SCRIPT_TYPE: ${{ inputs.script-type }}
        run: >
          tr ',' '\n' <<< "${AI_ASSISTANTS}"
          | xargs -L1 -t specify init --force --here --ignore-agent-tools --script "${SCRIPT_TYPE}" --ai
      - name: Prettify output files
        if: inputs.prettify-md-and-json
        run: >
          npx prettier --write './**/*.{md,json}'
      - name: Disable shellcheck in Spec Kit shell scripts
        if: inputs.script-type == 'sh' && inputs.disable-shellcheck
        working-directory: .specify/scripts
        run: |
          find . -type f -name '*.sh' -exec sed -ie '2i# shellcheck disable=all' {} \;
          find . -type f -name '*.she' -delete
      - name: Commit and push the changes
        uses: EndBug/add-and-commit@a94899bca583c204427a224a7af87c02f9b325d5  # v9.1.4
        with:
          add: ${{ inputs.git-add-args }}
          message: Update Spec Kit output files
          push: true
          github_token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}

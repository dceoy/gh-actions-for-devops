---
name: Pull request review using Claude Code
on:
  workflow_call:
    inputs:
      claude-args:
        required: false
        type: string
        description: Additional arguments to pass directly to Claude Code Action
        default: '--allowedTools "mcp__github_inline_comment__create_inline_comment"'
      runs-on:
        required: false
        type: string
        description: Runner to use
        default: ubuntu-slim
    secrets:
      CLAUDE_CODE_OAUTH_TOKEN:
        required: false
        description: OAuth token for Claude Code
      GH_TOKEN:
        required: false
        description: GitHub token for accessing the repository
#   pull_request:
#     types:
#       - opened
#       - synchronize
permissions:
  contents: read
jobs:
  claude-code-review:
    if: >
      github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    runs-on: ${{ inputs.runs-on }}
    env:
      CLAUDE_CODE_ACTION: anthropics/claude-code-action@1b8ee3b94104046d71fde52ec3557651ad8c0d71  # v1.0.29
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd  # v6.0.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}
          persist-credentials: false
      - name: Set environment variables
        run: >
          {
            echo "CLAUDE_CODE_ACTION_SHA=${CLAUDE_CODE_ACTION##*@}";
            echo "CLAUDE_CODE_ACTION_CACHE_DIR=${RUNNER_TEMP}/claude-code-action-cache";
          } >> "${GITHUB_ENV}"
      - name: Cache Claude Code Action assets
        id: claude-code-action-cache
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306  # v5.0.3
        with:
          path: ${{ env.RUNNER_TEMP }}/claude-code-action-cache
          key: claude-code-action-${{ env.CLAUDE_CODE_ACTION_SHA }}
      - name: Download Claude Code Action (if not cached)
        if: (! steps.claude-code-action-cache.outputs.cache-hit)
        run: |
          mkdir -p "${CLAUDE_CODE_ACTION_CACHE_DIR}"
          curl -fsSL \
            -o "${CLAUDE_CODE_ACTION_CACHE_DIR}/${CLAUDE_CODE_ACTION_SHA}.tar.gz" \
            "https://github.com/anthropics/claude-code-action/archive/${CLAUDE_CODE_ACTION_SHA}.tar.gz"
      - name: Extract and install agents and commands from Claude Code Action
        run: |
          [[ -d .claude ]] || mkdir -p .claude
          tar -xzf "${CLAUDE_CODE_ACTION_CACHE_DIR}/${CLAUDE_CODE_ACTION_SHA}.tar.gz" -C "${RUNNER_TEMP}/"
          rsync -av "${RUNNER_TEMP}/claude-code-action-${CLAUDE_CODE_ACTION_SHA}/.claude/agents/" .claude/agents/
          rsync -av "${RUNNER_TEMP}/claude-code-action-${CLAUDE_CODE_ACTION_SHA}/.claude/commands/" .claude/commands/
          [[ -f .claude/commands/review-pr.md ]] || exit 1
      - name: Run PR review with Claude Code
        uses: anthropics/claude-code-action@1b8ee3b94104046d71fde52ec3557651ad8c0d71  # v1.0.29
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: '/review-pr REPO: ${{ github.repository }} PR_NUMBER: ${{ github.event.pull_request.number }}'
          claude_args: ${{ inputs.claude-args }}
